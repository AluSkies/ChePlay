<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recomendaciones — ChePlay</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 20px; }
    .controls { margin-bottom: 12px; }
    .node { display:inline-block; padding:10px 16px; border-radius:24px; background:#2b8; color:#fff; margin:8px; }
    .edge { margin: 8px; color:#666 }
    #graph { margin-top:16px; }
  </style>
</head>
<body>
  <h2>Recomendación de amigos (visual)</h2>
    <div class="controls">
      <label>Usuario: <select id="user"></select></label>
      <label>K: <input id="k" type="number" value="5" style="width:64px"/></label>
      <button id="go">Obtener</button>
      <!-- song recommendations controls (Prim only) -->
      <button id="songsGo">Recomendar canciones (Prim)</button>
    </div>

  <div id="result">
    <p><strong>Directas:</strong> <span id="direct">—</span></p>
    <p><strong>Por camino (corto):</strong> <span id="shortest">—</span></p>
    <p><strong>Más cercano:</strong> <span id="closest">—</span></p>
  </div>

  <div id="songResults" style="margin-top:18px">
    <h3>Recomendaciones de canciones</h3>
    <div id="songsLoading" style="display:none">Cargando canciones...</div>
    <ul id="songsList"></ul>
  </div>

  <div id="trending" style="margin-top:18px">
    <h3>Trending global</h3>
    <button id="trendingRefresh">Actualizar trending</button>
    <div id="trendingLoading" style="display:none">Cargando trending...</div>
    <ul id="trendingList"></ul>
  </div>

  <hr style="margin:32px 0"/>

  <h2>Recomendaciones de películas</h2>
  <div class="controls">
    <label>Usuario: <select id="movieUser"></select></label>
    <label>K: <input id="movieK" type="number" value="5" style="width:64px"/></label>
    <label>Algoritmo:
      <select id="movieAlgorithm">
        <option value="bfs">BFS (Amplitud)</option>
        <option value="dfs">DFS (Profundidad)</option>
        <option value="diverse">Kruskal (Diverso)</option>
        <option value="sorted">MergeSort</option>
      </select>
    </label>
    <button id="movieGo">Recomendar películas</button>
  </div>

  <div id="movieResults" style="margin-top:18px">
    <h3>Películas recomendadas</h3>
    <div id="moviesLoading" style="display:none">Cargando...</div>
    <ul id="moviesList"></ul>
  </div>

  <hr style="margin:32px 0"/>

  <h2>Planificador de maratón de películas</h2>
  <div class="controls">
    <label>Usuario: <select id="marathonUser"></select></label>
    <label>Duración (min): <input id="marathonTime" type="number" value="360" style="width:80px"/></label>
    <label>Rating mínimo: <input id="marathonRating" type="number" value="3.5" step="0.5" style="width:60px"/></label>
    <label>Algoritmo:
      <select id="marathonAlgorithm">
        <option value="dp">Dynamic Programming</option>
        <option value="branchandbound">Branch & Bound</option>
      </select>
    </label>
    <button id="marathonGo">Planificar maratón</button>
  </div>

  <div id="marathonResults" style="margin-top:18px">
    <h3>Plan de maratón</h3>
    <div id="marathonLoading" style="display:none">Planificando...</div>
    <div id="marathonPlan"></div>
  </div>

  <hr style="margin:32px 0"/>

  <h2>Películas en tendencia</h2>
  <div class="controls">
    <label>Tipo:
      <select id="trendingType">
        <option value="global">Global (Greedy)</option>
        <option value="by-genre">Por Género (MergeSort)</option>
        <option value="influential">Influyentes (BFS)</option>
      </select>
    </label>
    <label id="genreLabel" style="display:none">
      Género: <input id="trendingGenre" type="text" placeholder="Sci-Fi, Action, Drama..." style="width:150px"/>
    </label>
    <label>K: <input id="movieTrendingK" type="number" value="10" style="width:64px"/></label>
    <button id="movieTrendingGo">Ver trending</button>
  </div>

  <div id="movieTrendingResults" style="margin-top:18px">
    <h3 id="movieTrendingTitle">Top películas</h3>
    <div id="movieTrendingLoading" style="display:none">Cargando...</div>
    <ul id="movieTrendingList"></ul>
  </div>

  <div id="graph"></div>

  <script>
    function formatUserList(list) {
      if (!Array.isArray(list) || list.length === 0) return '—';
      return list.map(item => formatUser(item)).join(', ');
    }

    function formatUser(item) {
      if (!item) return '—';
      if (typeof item === 'string') return item;
      return item.label || item.name || item.id || '—';
    }

    async function fetchUsers() {
      const res = await fetch('/api/recommendations/users');
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const list = await res.json();
      const sel = document.getElementById('user');
      sel.innerHTML = '';
      // list may be an array or an object with value field depending on the controller
      const users = Array.isArray(list) ? list : (list.value || list);
      users.forEach(u => {
        const opt = document.createElement('option');
        if (u && typeof u === 'object') {
          const value = u.id || u.value || '';
          opt.value = value;
          opt.textContent = u.label || u.name || u.username || value;
        } else {
          opt.value = u;
          opt.textContent = u;
        }
        sel.appendChild(opt);
      });
      // set default
      if (sel.options.length > 0) sel.value = sel.options[0].value;
    }

    async function fetchRec(user, k) {
      const res = await fetch(`/api/recommendations/closest?user=${encodeURIComponent(user)}&k=${k}`);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return await res.json();
    }

    async function fetchSongRec(user, k, window, lambda) {
      let qs = `user=${encodeURIComponent(user)}&k=${k}`;
      if (window != null) qs += `&window=${encodeURIComponent(window)}`;
      if (lambda != null) qs += `&lambda=${encodeURIComponent(lambda)}`;
      const res = await fetch(`/api/recommendations/songs?${qs}`);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return await res.json();
    }

    async function fetchTrending(k, platforms) {
      const params = new URLSearchParams();
      params.set('k', k);
      if (platforms && platforms.length) {
        params.set('platforms', platforms.join(','));
      }
      const res = await fetch(`/api/trending/global?${params.toString()}`);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return await res.json();
    }

    function render(resp) {
  document.getElementById('direct').textContent = formatUserList(resp.directRecommendations);
  document.getElementById('shortest').textContent = formatUserList(resp.shortestPathRecommendations);
  document.getElementById('closest').textContent = formatUser(resp.closest);

      const graph = document.getElementById('graph');
      graph.innerHTML = '';
      const select = document.getElementById('user');
      const selectedOption = select && select.selectedIndex >= 0 ? select.options[select.selectedIndex] : null;
      const userLabel = selectedOption ? selectedOption.textContent : resp.user;
  const closestObj = resp.closest;
  const closestId = closestObj && closestObj.id;
  const closestLabel = formatUser(closestObj);

      // Render simple visual: user node and closest node, connect if appears in direct recommendations
      const u = document.createElement('div'); u.className='node'; u.textContent = userLabel;
      graph.appendChild(u);

      if (closestId && closestLabel && closestLabel !== '—') {
        const v = document.createElement('div'); v.className='node'; v.textContent = closestLabel; v.style.background='#28f';
        graph.appendChild(v);

        // edge
        const edge = document.createElement('div'); edge.className='edge';
        const isDirect = Array.isArray(resp.directRecommendations) && resp.directRecommendations.some(item => item && item.id === closestId);
        edge.textContent = isDirect ? 'Conexión directa' : 'Conexión por camino más corto';
        graph.appendChild(edge);
      }
    }

    function renderTrending(items) {
      const list = document.getElementById('trendingList');
      list.innerHTML = '';
      if (!items || items.length === 0) {
        list.innerHTML = '<li>No hay datos</li>';
        return;
      }
      items.forEach((item, idx) => {
        const li = document.createElement('li');
        const title = item.title || item.songId || 'Desconocido';
        const artist = item.artist ? ` — ${item.artist}` : '';
        li.textContent = `${idx + 1}. ${title}${artist} (${item.plays} plays)`;
        list.appendChild(li);
      });
    }

    document.getElementById('go').addEventListener('click', async () => {
      const user = document.getElementById('user').value.trim();
      const k = parseInt(document.getElementById('k').value, 10) || 5;
      try {
        document.getElementById('closest').textContent = 'Cargando...';
        const resp = await fetchRec(user, k);
        render(resp);
      } catch (err) {
        alert('Error: ' + err.message);
        console.error(err);
      }
    });

    document.getElementById('songsGo').addEventListener('click', async () => {
      const user = document.getElementById('user').value.trim();
      const k = parseInt(document.getElementById('k').value, 10) || 5;
      try {
        document.getElementById('songsLoading').style.display = 'block';
        document.getElementById('songsList').innerHTML = '';
        // optional: window and lambda could be exposed in UI; use defaults for now
        const resp = await fetchSongRec(user, k, null, null);
        document.getElementById('songsLoading').style.display = 'none';
        const list = document.getElementById('songsList');
        if (!resp || resp.length === 0) {
          list.innerHTML = '<li>No hay recomendaciones</li>';
          return;
        }
        for (const item of resp) {
          const li = document.createElement('li');
          const label = item.label || [item.artist, item.title].filter(Boolean).join(' - ') || item.id;
          const score = (typeof item.score === 'number') ? item.score.toFixed(3).replace(/\.000$/, '') : item.score;
          li.textContent = `${label} (score: ${score})`;
          list.appendChild(li);
        }
      } catch (err) {
        document.getElementById('songsLoading').style.display = 'none';
        alert('Error al obtener canciones: ' + err.message);
        console.error(err);
      }
    });

    async function loadTrending() {
      try {
        document.getElementById('trendingLoading').style.display = 'block';
        const list = await fetchTrending(10, null);
        document.getElementById('trendingLoading').style.display = 'none';
        renderTrending(list);
      } catch (err) {
        document.getElementById('trendingLoading').style.display = 'none';
        console.error('Error al obtener trending', err);
        document.getElementById('trendingList').innerHTML = '<li>Error al cargar trending</li>';
      }
    }

    document.getElementById('trendingRefresh').addEventListener('click', loadTrending);

    // Movie Recommendations
    async function fetchMovieRecommendations(user, k, algorithm) {
      const res = await fetch(`/api/movies/recommendations/${algorithm}?user=${encodeURIComponent(user)}&k=${k}`);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return await res.json();
    }

    document.getElementById('movieGo').addEventListener('click', async () => {
      const user = document.getElementById('movieUser').value.trim();
      const k = parseInt(document.getElementById('movieK').value, 10) || 5;
      const algorithm = document.getElementById('movieAlgorithm').value;
      try {
        document.getElementById('moviesLoading').style.display = 'block';
        document.getElementById('moviesList').innerHTML = '';
        const movies = await fetchMovieRecommendations(user, k, algorithm);
        document.getElementById('moviesLoading').style.display = 'none';
        const list = document.getElementById('moviesList');
        if (!movies || movies.length === 0) {
          list.innerHTML = '<li>No hay recomendaciones</li>';
          return;
        }
        for (const movie of movies) {
          const li = document.createElement('li');
          const title = movie.title || movie.id;
          const genre = movie.genre ? ` [${movie.genre}]` : '';
          const year = movie.year ? ` (${movie.year})` : '';
          const score = movie.score != null ? movie.score.toFixed(3) : 'N/A';
          li.textContent = `${title}${genre}${year} - Score: ${score}`;
          list.appendChild(li);
        }
      } catch (err) {
        document.getElementById('moviesLoading').style.display = 'none';
        alert('Error al obtener recomendaciones: ' + err.message);
        console.error(err);
      }
    });

    // Marathon Planning
    async function fetchMarathonPlan(user, totalMinutes, minRating, algorithm) {
      const res = await fetch(`/api/movies/marathon/quick?user=${encodeURIComponent(user)}&totalMinutes=${totalMinutes}&minRating=${minRating}&algorithm=${algorithm}`);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return await res.json();
    }

    document.getElementById('marathonGo').addEventListener('click', async () => {
      const user = document.getElementById('marathonUser').value.trim();
      const totalMinutes = parseInt(document.getElementById('marathonTime').value, 10) || 360;
      const minRating = parseFloat(document.getElementById('marathonRating').value) || 3.5;
      const algorithm = document.getElementById('marathonAlgorithm').value;
      try {
        document.getElementById('marathonLoading').style.display = 'block';
        document.getElementById('marathonPlan').innerHTML = '';
        const plan = await fetchMarathonPlan(user, totalMinutes, minRating, algorithm);
        document.getElementById('marathonLoading').style.display = 'none';
        const planDiv = document.getElementById('marathonPlan');
        if (!plan.movies || plan.movies.length === 0) {
          planDiv.innerHTML = '<p>No se encontraron películas para el maratón</p>';
          return;
        }
        const summary = `<p><strong>Algoritmo:</strong> ${plan.algorithm}</p>
          <p><strong>Duración total:</strong> ${plan.totalDuration} minutos (${(plan.totalDuration/60).toFixed(1)} horas)</p>
          <p><strong>Rating promedio:</strong> ${plan.averageRating.toFixed(2)}</p>
          <p><strong>Películas (${plan.movies.length}):</strong></p>`;
        const list = document.createElement('ul');
        for (const movie of plan.movies) {
          const li = document.createElement('li');
          const title = movie.title || movie.movieId;
          const genre = movie.genre ? ` [${movie.genre}]` : '';
          const duration = movie.duration ? ` - ${movie.duration} min` : '';
          const rating = movie.rating != null ? ` - Rating: ${movie.rating.toFixed(1)}` : '';
          li.textContent = `${title}${genre}${duration}${rating}`;
          list.appendChild(li);
        }
        planDiv.innerHTML = summary;
        planDiv.appendChild(list);
      } catch (err) {
        document.getElementById('marathonLoading').style.display = 'none';
        alert('Error al planificar maratón: ' + err.message);
        console.error(err);
      }
    });

    // Movie Trending - Show/hide genre input based on trending type
    document.getElementById('trendingType').addEventListener('change', function() {
      const genreLabel = document.getElementById('genreLabel');
      if (this.value === 'by-genre') {
        genreLabel.style.display = 'inline-block';
      } else {
        genreLabel.style.display = 'none';
      }
    });

    async function fetchMovieTrending(type, k, genre) {
      let url;
      if (type === 'global') {
        url = `/api/movies/trending/global?k=${k}`;
      } else if (type === 'by-genre') {
        if (!genre || genre.trim() === '') {
          throw new Error('Debe especificar un género');
        }
        url = `/api/movies/trending/by-genre?genre=${encodeURIComponent(genre)}&k=${k}`;
      } else if (type === 'influential') {
        url = `/api/movies/trending/influential?k=${k}`;
      }
      const res = await fetch(url);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return await res.json();
    }

    document.getElementById('movieTrendingGo').addEventListener('click', async () => {
      const type = document.getElementById('trendingType').value;
      const k = parseInt(document.getElementById('movieTrendingK').value, 10) || 10;
      const genre = document.getElementById('trendingGenre').value.trim();
      
      try {
        document.getElementById('movieTrendingLoading').style.display = 'block';
        document.getElementById('movieTrendingList').innerHTML = '';
        
        const movies = await fetchMovieTrending(type, k, genre);
        
        document.getElementById('movieTrendingLoading').style.display = 'none';
        
        // Update title based on type
        const titleEl = document.getElementById('movieTrendingTitle');
        if (type === 'global') {
          titleEl.textContent = 'Top películas globales';
        } else if (type === 'by-genre') {
          titleEl.textContent = `Top películas de ${genre}`;
        } else if (type === 'influential') {
          titleEl.textContent = 'Películas más influyentes';
        }
        
        const list = document.getElementById('movieTrendingList');
        if (!movies || movies.length === 0) {
          list.innerHTML = '<li>No hay datos</li>';
          return;
        }
        
        for (let i = 0; i < movies.length; i++) {
          const movie = movies[i];
          const li = document.createElement('li');
          const title = movie.title || movie.movieId;
          const movieGenre = movie.genre ? ` [${movie.genre}]` : '';
          
          if (type === 'influential') {
            const influence = movie.influenceScore || 0;
            const year = movie.year ? ` (${movie.year})` : '';
            li.textContent = `${i+1}. ${title}${movieGenre}${year} - Influencia: ${influence} películas`;
          } else {
            const watches = movie.watchCount || 0;
            li.textContent = `${i+1}. ${title}${movieGenre} - ${watches} views`;
          }
          
          list.appendChild(li);
        }
      } catch (err) {
        document.getElementById('movieTrendingLoading').style.display = 'none';
        alert('Error al cargar trending: ' + err.message);
        console.error(err);
      }
    });

    // Load users on startup and populate movie dropdowns
    (async () => {
      try { 
        await fetchUsers(); 
        // Populate movie user selects
        const mainUserSelect = document.getElementById('user');
        const movieUserSelect = document.getElementById('movieUser');
        const marathonUserSelect = document.getElementById('marathonUser');
        
        if (mainUserSelect.options.length > 0) {
          for (let i = 0; i < mainUserSelect.options.length; i++) {
            const opt1 = document.createElement('option');
            opt1.value = mainUserSelect.options[i].value;
            opt1.textContent = mainUserSelect.options[i].textContent;
            movieUserSelect.appendChild(opt1);
            
            const opt2 = document.createElement('option');
            opt2.value = mainUserSelect.options[i].value;
            opt2.textContent = mainUserSelect.options[i].textContent;
            marathonUserSelect.appendChild(opt2);
          }
        }
      } catch (e) { console.warn('No users list', e); }
      await loadTrending();
    })();
  </script>
</body>
</html>
